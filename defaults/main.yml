---
# =============================================================================
# CrowdSec Role for Trellis
# =============================================================================

# Master switch - set to false to skip all CrowdSec tasks
crowdsec_enabled: true

# =============================================================================
# Legacy Migration (fail2ban + ferm)
# =============================================================================

# Stop and disable fail2ban/ferm when CrowdSec is enabled
crowdsec_disable_legacy: true

# Flush iptables rules from ferm (use with caution - only after confirming CrowdSec works)
crowdsec_flush_legacy_rules: false

# =============================================================================
# Package Installation
# =============================================================================

crowdsec_packages:
  - crowdsec

crowdsec_service_enabled: true
crowdsec_service_state: started

# =============================================================================
# CrowdSec Hub - Collections, Parsers, Scenarios
# =============================================================================

# Collections to install (includes parsers + scenarios)
# For Trellis WordPress, recommended collections are set here
crowdsec_collections:
  - crowdsecurity/linux
  - crowdsecurity/nginx
  - crowdsecurity/sshd
  - crowdsecurity/base-http-scenarios
  - crowdsecurity/http-cve
  - crowdsecurity/wordpress
  - crowdsecurity/whitelist-good-actors

# Additional parsers (beyond what collections provide)
crowdsec_parsers: []

# Additional scenarios (beyond what collections provide)
crowdsec_scenarios: []

# Scenarios to remove (useful for disabling false-positive-prone scenarios from collections)
# Use full scenario names as shown by `cscli scenarios list`
crowdsec_scenarios_remove: []
# Example - disable http-probing entirely:
#   - crowdsecurity/http-probing

# HTTP Probing scenario customization
# The default http-probing scenario triggers on 404, 403, and 400 responses.
# For WordPress/REST APIs, 404s are often legitimate ("resource not found").
# Set to true to deploy a modified version that only triggers on 403/400.
crowdsec_http_probing_exclude_404: false

# =============================================================================
# Ban Durations (Profiles)
# =============================================================================
# CrowdSec uses "profiles" to determine what action to take when a scenario
# triggers. This role deploys a custom profiles.yaml with sensible defaults.
#
# Ban duration format: "4h" (hours), "30m" (minutes), "7d" (days)

# Default ban duration for CrowdSec Hub scenarios (ssh-bf, http-probing, etc.)
crowdsec_ban_duration_default: "4h"

# =============================================================================
# Built-in Scenarios
# =============================================================================
# These scenarios are included with this role and enabled by default.
# Each scenario has tunable parameters explained below.
#
# SCENARIO PARAMETERS:
# --------------------
# capacity    - Number of events allowed before triggering (bucket size)
#               Lower = more sensitive, Higher = more tolerant
#
# leakspeed   - How fast the bucket drains (one event leaks per interval)
#               "1m" = 1 event drains per minute, "30s" = 1 per 30 seconds
#               Faster leak = more tolerant of slow attacks
#
# blackhole   - Cooldown after triggering before scenario can fire again
#               Prevents alert spam for persistent attackers
#
# ban_duration - How long the IP is banned when this scenario triggers
#
# TYPE: "leaky" vs "trigger"
# --------------------------
# leaky   - Bucket-based rate limiting (uses capacity/leakspeed/blackhole)
# trigger - Immediate action on first match (no rate limiting)

# -----------------------------------------------------------------------------
# Actuator Probe Detection
# -----------------------------------------------------------------------------
# Detects probing for Spring Boot actuator endpoints (/actuator, /heapdump)
# which expose sensitive application data. Common in automated scanners.
crowdsec_scenario_actuator_probe: true
crowdsec_scenario_actuator_probe_capacity: 3      # Trigger after 3 requests
crowdsec_scenario_actuator_probe_leakspeed: "1m"  # Drain 1 request per minute
crowdsec_scenario_actuator_probe_blackhole: "5m"  # 5 min cooldown between alerts
crowdsec_scenario_actuator_probe_ban: "24h"       # Ban for 24 hours

# -----------------------------------------------------------------------------
# Debug Endpoint Fuzzing
# -----------------------------------------------------------------------------
# Detects probing for debug endpoints and error parameters that could
# leak stack traces, configuration, or other sensitive information.
# Paths: /debug, ?error=, ?stacktrace=, ?exception=
crowdsec_scenario_debug_fuzzing: true
crowdsec_scenario_debug_fuzzing_capacity: 5       # Trigger after 5 requests
crowdsec_scenario_debug_fuzzing_leakspeed: "30s"  # Drain 1 request per 30 seconds
crowdsec_scenario_debug_fuzzing_blackhole: "10m"  # 10 min cooldown between alerts
crowdsec_scenario_debug_fuzzing_ban: "12h"        # Ban for 12 hours

# -----------------------------------------------------------------------------
# Custom Bad User Agent Detection
# -----------------------------------------------------------------------------
# Supplements the Hub's http-bad-user-agent scenario (500+ patterns) with
# immediate blocking for the most egregious scanner user agents.
#
# Hub scenario triggers after 2 requests; this triggers immediately.
# Detected agents: ffuf, sqlmap, nikto, nuclei, gobuster, dirbuster, wpscan,
#                  Team Anon Force, Mozlila, Moz111a
#
# TYPE: trigger (immediate ban on first match - no capacity/leakspeed)
crowdsec_scenario_custom_bad_user_agent: true
crowdsec_scenario_custom_bad_user_agent_ban: "168h"  # Ban for 7 days (serious intent)

# -----------------------------------------------------------------------------
# SSRF Callback Detection
# -----------------------------------------------------------------------------
# Detects Server-Side Request Forgery (SSRF) attempts using callback domains
# to exfiltrate data or confirm vulnerabilities. These domains are used by
# security testing tools (Burp, nuclei, etc.) for out-of-band detection.
#
# Detected domains: burpcollaborator.net, oastify.com, interact.sh,
#                   canarytokens.com, requestbin.net, webhook.site, *.oast.*
#
# TYPE: trigger (immediate ban on first match - no capacity/leakspeed)
crowdsec_scenario_ssrf_callback: true
crowdsec_scenario_ssrf_callback_ban: "168h"       # Ban for 7 days (active exploitation)

# =============================================================================
# Console Enrollment (optional - for CrowdSec Console dashboard)
# =============================================================================

crowdsec_console_token: ""

# =============================================================================
# Log Acquisition
# =============================================================================

# Trellis-aware defaults: logs are at /srv/www/{site}/logs/
# Override in group_vars if using non-standard paths
crowdsec_acquisition:
  - filenames:
      - /srv/www/*/logs/access.log
    labels:
      type: nginx
  - filenames:
      - /srv/www/*/logs/error.log
    labels:
      type: nginx
  - filenames:
      - /var/log/nginx/access.log
      - /var/log/nginx/error.log
    labels:
      type: nginx
  - filenames:
      - /var/log/auth.log
    labels:
      type: syslog

# =============================================================================
# Firewall Bouncer
# =============================================================================

crowdsec_firewall_bouncer_enabled: true
crowdsec_firewall_bouncer_package: crowdsec-firewall-bouncer-nftables
crowdsec_firewall_bouncer_mode: nftables

crowdsec_firewall_bouncer_service_enabled: true
crowdsec_firewall_bouncer_service_state: started

# =============================================================================
# IP Whitelists
# =============================================================================

# Trellis ip_whitelist - define here or override in group_vars
# Used by CrowdSec whitelist and can be reused by other roles
ip_whitelist:
  - 127.0.0.0/8

# IPs that should never be blocked by CrowdSec
# Automatically derives from ip_whitelist, filtering empty values
crowdsec_whitelists: "{{ ip_whitelist | default([]) | select('string') | reject('==', '') | list }}"

# =============================================================================
# Blocked IPs Import
# =============================================================================

# Trellis blocked_ips - define here or override in group_vars
# IPs to permanently block
blocked_ips: []

# Import blocked_ips as CrowdSec decisions
crowdsec_import_blocked_ips: true

# IPs/CIDRs to block - derives from blocked_ips by default
crowdsec_blocked_ips: "{{ blocked_ips | default([]) }}"

# Duration for imported blocked IPs (10 years)
crowdsec_blocked_ips_duration: "87600h"

# =============================================================================
# Custom Scenarios
# =============================================================================

# Define custom scenarios (ported from fail2ban or custom rules)
crowdsec_custom_scenarios: []
# Example:
#   - name: wordpress-admin-exploit
#     description: "Detect WordPress admin exploitation attempts"
#     type: leaky
#     filter: "evt.Meta.http_path contains '/wp-login.php' and evt.Meta.http_args contains 'lostpassword'"
#     groupby: evt.Meta.source_ip
#     capacity: 1
#     leakspeed: 24h
#     blackhole: 24h
#     labels:
#       service: wordpress
#       type: exploit
#       remediation: true
