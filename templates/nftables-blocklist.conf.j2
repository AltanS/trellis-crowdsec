#!/usr/sbin/nft -f
# Managed by Ansible (trellis-crowdsec role) - do not edit manually
#
# Supplements CrowdSec's firewall bouncer with proper CIDR range support.
# The bouncer creates nftables sets with `type ipv4_addr; flags timeout` which
# cannot match CIDR ranges (known bug). This table uses `flags interval` to
# enforce both single IPs and CIDR ranges from the ip_blocklist variable.
#
# NOTE: nftables interval sets do not allow overlapping ranges.
# If ip_blocklist contains overlapping entries (e.g. 10.0.0.0/8 and 10.1.0.0/16),
# nft will reject the configuration. Remove the more specific range.

table inet trellis_blocklist {
  set blocked_v4 {
    type ipv4_addr
    flags interval
{% if ip_blocklist | default([]) | length > 0 %}
    elements = {
{% for ip in ip_blocklist | default([]) %}
      {{ ip }}{{ "," if not loop.last else "" }}
{% endfor %}
    }
{% endif %}
  }

  chain input {
    type filter hook input priority -1; policy accept;
    ip saddr @blocked_v4 drop
  }
}
